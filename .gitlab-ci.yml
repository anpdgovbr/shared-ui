# GitLab CI/CD Pipeline para @anpdgovbr/shared-ui
# Biblioteca de componentes React com MUI v7 e padr√£o GovBR-DS para ANPD

# ‚úÖ Configura√ß√µes globais
default:
  image: harbor.anpd.gov.br/library/node-pnpm:22-ca2

  # Cache global para otimizar instala√ß√£o de depend√™ncias
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules/
    policy: pull

# Vari√°veis de ambiente globais
variables:
  NODE_VERSION: '22'
  PNPM_VERSION: '10.22.0'
  # Configura√ß√µes pnpm
  PNPM_HOME: '/root/.local/share/pnpm'
  # For√ßar frozen lockfile para garantir reprodutibilidade
  FROZEN_LOCKFILE: 'true'
  # Desabilitar telemetria em CI
  DISABLE_TELEMETRY: 'true'
  CI: 'true'

# Definir ordem de execu√ß√£o dos est√°gios
stages:
  - install
  - lint
  - test
  - build
  - deploy

# ==========================================
# STAGE: INSTALL
# ==========================================
# Job respons√°vel por instalar depend√™ncias
install:
  stage: install
  timeout: 10m

  # Cache com pol√≠tica push para popular o cache
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules/
    policy: push

  before_script:
    # Instalar pnpm
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store

  script:
    - echo "üì¶ Instalando depend√™ncias..."
    - pnpm install --frozen-lockfile
    - echo "‚úÖ Depend√™ncias instaladas com sucesso"

  # N√£o criar artefatos - usar apenas cache
  # artifacts:
  #   paths:
  #     - node_modules/
  #     - .pnpm-store/
  #   expire_in: 1 hour

# ==========================================
# STAGE: LINT
# ==========================================
# Job para verifica√ß√£o de linting e formata√ß√£o
lint:
  stage: lint
  timeout: 10m
  needs: []

  # Usar cache ao inv√©s de artifacts
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules/
    policy: pull

  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
    # Reinstalar se cache n√£o estiver dispon√≠vel
    - |
      if [ ! -d "node_modules" ]; then
        echo "‚ö†Ô∏è Cache n√£o encontrado, instalando depend√™ncias..."
        pnpm install --frozen-lockfile
      fi

  script:
    - echo "üîç Executando lint..."
    - pnpm run lint
    - echo "‚úÖ Lint passou com sucesso"

  # Permitir visualiza√ß√£o de erros de lint
  artifacts:
    when: on_failure
    reports:
      codequality: gl-code-quality-report.json
    expire_in: 1 week

# Job separado para type checking
type-check:
  stage: lint
  timeout: 10m
  needs: []

  # Usar cache ao inv√©s de artifacts
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules/
    policy: pull

  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
    # Reinstalar se cache n√£o estiver dispon√≠vel
    - |
      if [ ! -d "node_modules" ]; then
        echo "‚ö†Ô∏è Cache n√£o encontrado, instalando depend√™ncias..."
        pnpm install --frozen-lockfile
      fi

  script:
    - echo "üîç Executando type check..."
    - pnpm run typecheck
    - echo "‚úÖ Type check passou com sucesso"

# ==========================================
# STAGE: TEST
# ==========================================
# Job para execu√ß√£o de testes
test:
  stage: test
  timeout: 15m
  needs: []

  # Usar cache ao inv√©s de artifacts
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules/
    policy: pull

  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
    # Reinstalar se cache n√£o estiver dispon√≠vel
    - |
      if [ ! -d "node_modules" ]; then
        echo "‚ö†Ô∏è Cache n√£o encontrado, instalando depend√™ncias..."
        pnpm install --frozen-lockfile
      fi

  script:
    - echo "üß™ Executando testes..."
    - pnpm test
    - echo "‚úÖ Testes passaram com sucesso"

  # Cobertura de testes como artefato
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: coverage/junit.xml
    paths:
      - coverage/
    expire_in: 1 week

# ==========================================
# STAGE: BUILD
# ==========================================
# Job para build da biblioteca
build:
  stage: build
  timeout: 15m
  needs:
    - lint
    - type-check
    - test

  # Usar cache ao inv√©s de artifacts
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules/
    policy: pull

  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
    # Reinstalar se cache n√£o estiver dispon√≠vel
    - |
      if [ ! -d "node_modules" ]; then
        echo "‚ö†Ô∏è Cache n√£o encontrado, instalando depend√™ncias..."
        pnpm install --frozen-lockfile
      fi

  script:
    - echo "üèóÔ∏è Executando build..."
    - pnpm run build

    # Validar que arquivos essenciais foram gerados
    - |
      if [ ! -d "dist" ]; then
        echo "‚ùå Erro: diret√≥rio dist/ n√£o foi criado"
        exit 1
      fi
      if [ ! -d "types" ]; then
        echo "‚ùå Erro: diret√≥rio types/ n√£o foi criado"
        exit 1
      fi
      echo "‚úÖ Build validado com sucesso"

    # Validar exports
    - pnpm run validate:exports || echo "‚ö†Ô∏è Valida√ß√£o de exports falhou (n√£o cr√≠tico)"

  artifacts:
    paths:
      - dist/
      - types/
    expire_in: 30 days

# ==========================================
# STAGE: BUILD STORYBOOK (DESABILITADO)
# ==========================================
# Job para build do Storybook (apenas na main)
# NOTA: Comentado para ativa√ß√£o posterior
# build-storybook:
#   stage: build
#   timeout: 20m
#   needs: [install]
#
#   # Executar apenas na branch main
#   only:
#     - main
#
#   before_script:
#     - corepack enable
#     - corepack prepare pnpm@${PNPM_VERSION} --activate
#
#   script:
#     - echo "üìö Executando build do Storybook..."
#     - pnpm run build-storybook
#     - echo "‚úÖ Storybook build conclu√≠do com sucesso"
#
#   artifacts:
#     paths:
#       - storybook-static/
#     expire_in: 7 days

# ==========================================
# STAGE: DEPLOY (DESABILITADO)
# ==========================================
# Job para deploy do Storybook (manual)
# NOTA: Comentado para ativa√ß√£o posterior
# deploy-storybook:
#   stage: deploy
#   timeout: 10m
#   needs: [build-storybook]
#
#   # Deploy manual apenas na main
#   only:
#     - main
#   when: manual
#
#   before_script:
#     - corepack enable
#     - corepack prepare pnpm@${PNPM_VERSION} --activate
#
#   script:
#     - echo "üöÄ Iniciando deploy do Storybook..."
#     # Customize este script conforme seu ambiente de deploy
#     - |
#       if [ -f "./deploy-storybook.sh" ]; then
#         chmod +x ./deploy-storybook.sh
#         NGINX_RELOAD=true ./deploy-storybook.sh
#       else
#         echo "‚ö†Ô∏è Script de deploy n√£o encontrado"
#         echo "üì¶ Artefatos dispon√≠veis em storybook-static/"
#       fi
#     - echo "‚úÖ Deploy conclu√≠do"
#
#   environment:
#     name: storybook
#     url: https://seu-dominio.gov.br/shared-ui
#
#   artifacts:
#     paths:
#       - storybook-static/
#     expire_in: 30 days

# ==========================================
# JOBS AUXILIARES
# ==========================================

# Job para verificar seguran√ßa de depend√™ncias
security-check:
  stage: test
  timeout: 10m
  needs: []

  # Usar cache ao inv√©s de artifacts
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules/
    policy: pull

  # Executar apenas em MRs e main
  only:
    - merge_requests
    - main

  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
    # Reinstalar se cache n√£o estiver dispon√≠vel
    - |
      if [ ! -d "node_modules" ]; then
        echo "‚ö†Ô∏è Cache n√£o encontrado, instalando depend√™ncias..."
        pnpm install --frozen-lockfile
      fi

  script:
    - echo "üîí Verificando vulnerabilidades de seguran√ßa..."
    - pnpm audit --audit-level=moderate || echo "‚ö†Ô∏è Vulnerabilidades encontradas"

  allow_failure: true

# Job para an√°lise de bundle size (informativo)
# NOTA: Comentado para ativa√ß√£o posterior
# bundle-analysis:
#   stage: build
#   timeout: 15m
#   needs: [build]
#
#   # Executar apenas na main
#   only:
#     - main
#
#   before_script:
#     - corepack enable
#     - corepack prepare pnpm@${PNPM_VERSION} --activate
#
#   script:
#     - echo "üìä Analisando tamanho do bundle..."
#     - ls -lh dist/
#     - du -sh dist/
#
#   allow_failure: true

# ==========================================
# WORKFLOW RULES
# ==========================================
workflow:
  rules:
    # Executar em pushes para main
    - if: $CI_COMMIT_BRANCH == "main"
    # Executar em merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Executar em tags
    - if: $CI_COMMIT_TAG
