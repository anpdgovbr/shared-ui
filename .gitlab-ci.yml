# GitLab CI/CD Pipeline para @anpdgovbr/shared-ui
# Biblioteca de componentes React com MUI v7 e padr√£o GovBR-DS para ANPD

# ‚úÖ Configura√ß√µes globais
default:
  image: harbor.anpd.gov.br/library/node-pnpm:22-ca2

  # Cache global para otimizar instala√ß√£o de depend√™ncias
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules/
    policy: pull

# Vari√°veis de ambiente globais
variables:
  NODE_VERSION: '22'
  PNPM_VERSION: '10.22.0'
  # Configura√ß√µes pnpm
  PNPM_HOME: '/root/.local/share/pnpm'
  # For√ßar frozen lockfile para garantir reprodutibilidade
  FROZEN_LOCKFILE: 'true'
  # Desabilitar telemetria em CI
  DISABLE_TELEMETRY: 'true'
  CI: 'true'

# Definir ordem de execu√ß√£o dos est√°gios
stages:
  - install
  - lint
  - test
  - build
  - deploy

# ==========================================
# STAGE: INSTALL
# ==========================================
# Job respons√°vel por instalar depend√™ncias
install:
  stage: install
  timeout: 10m

  # Cache com pol√≠tica push para popular o cache
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules/
    policy: push

  before_script:
    # Instalar pnpm
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store

  script:
    - echo "üì¶ Instalando depend√™ncias..."
    - pnpm install --frozen-lockfile
    - echo "‚úÖ Depend√™ncias instaladas com sucesso"

# ==========================================
# STAGE: LINT
# ==========================================
# Job para verifica√ß√£o de linting e formata√ß√£o
lint:
  stage: lint
  timeout: 10m
  needs: []

  # Usar cache ao inv√©s de artifacts
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules/
    policy: pull

  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
    # Reinstalar se cache n√£o estiver dispon√≠vel
    - |
      if [ ! -d "node_modules" ]; then
        echo "‚ö†Ô∏è Cache n√£o encontrado, instalando depend√™ncias..."
        pnpm install --frozen-lockfile
      fi

  script:
    - echo "üîç Executando lint..."
    - pnpm run lint
    - echo "‚úÖ Lint passou com sucesso"

  # Permitir visualiza√ß√£o de erros de lint
  artifacts:
    when: on_failure
    reports:
      codequality: gl-code-quality-report.json
    expire_in: 1 week

# Job separado para type checking
type-check:
  stage: lint
  timeout: 10m
  needs: []

  # Usar cache ao inv√©s de artifacts
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules/
    policy: pull

  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
    # Reinstalar se cache n√£o estiver dispon√≠vel
    - |
      if [ ! -d "node_modules" ]; then
        echo "‚ö†Ô∏è Cache n√£o encontrado, instalando depend√™ncias..."
        pnpm install --frozen-lockfile
      fi

  script:
    - echo "üîç Executando type check..."
    - pnpm run typecheck
    - echo "‚úÖ Type check passou com sucesso"

# ==========================================
# STAGE: TEST
# ==========================================
# Job para execu√ß√£o de testes
test:
  stage: test
  timeout: 15m
  needs: []

  # Usar cache ao inv√©s de artifacts
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules/
    policy: pull

  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
    # Reinstalar se cache n√£o estiver dispon√≠vel
    - |
      if [ ! -d "node_modules" ]; then
        echo "‚ö†Ô∏è Cache n√£o encontrado, instalando depend√™ncias..."
        pnpm install --frozen-lockfile
      fi

  script:
    - echo "üß™ Executando testes..."
    - pnpm test
    - echo "‚úÖ Testes passaram com sucesso"

  # Cobertura de testes como artefato
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: coverage/junit.xml
    paths:
      - coverage/
    expire_in: 1 week

# ==========================================
# STAGE: BUILD
# ==========================================
# Job para build da biblioteca
build:
  stage: build
  timeout: 15m
  needs:
    - lint
    - type-check
    - test

  # Usar cache ao inv√©s de artifacts
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules/
    policy: pull

  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
    # Reinstalar se cache n√£o estiver dispon√≠vel
    - |
      if [ ! -d "node_modules" ]; then
        echo "‚ö†Ô∏è Cache n√£o encontrado, instalando depend√™ncias..."
        pnpm install --frozen-lockfile
      fi

  script:
    - echo "üèóÔ∏è Executando build..."
    - pnpm run build

    # Validar que arquivos essenciais foram gerados
    - |
      if [ ! -d "dist" ]; then
        echo "‚ùå Erro: diret√≥rio dist/ n√£o foi criado"
        exit 1
      fi
      if [ ! -d "types" ]; then
        echo "‚ùå Erro: diret√≥rio types/ n√£o foi criado"
        exit 1
      fi
      echo "‚úÖ Build validado com sucesso"

    # Validar exports
    - pnpm run validate:exports || echo "‚ö†Ô∏è Valida√ß√£o de exports falhou (n√£o cr√≠tico)"

  artifacts:
    paths:
      - dist/
      - types/
    expire_in: 30 days

# ==========================================
# STAGE: DEPLOY - PUBLICA√á√ÉO NO VERDACCIO
# ==========================================

# Job para criar changeset automaticamente em MRs (se necess√°rio)
create-changeset:
  stage: deploy
  timeout: 5m
  needs: []

  # Executar apenas em merge requests
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
    - when: never

  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store

  script:
    - echo "üîç Verificando se h√° changeset no MR..."
    
    # Verificar se existe algum changeset
    - |
      if [ -z "$(ls -A .changeset/*.md 2>/dev/null | grep -v 'README.md' | grep -v 'config.json')" ]; then
        echo "‚ö†Ô∏è Nenhum changeset encontrado. Criando automaticamente..."
        
        # Extrair informa√ß√µes do MR
        MR_TITLE="${CI_MERGE_REQUEST_TITLE:-Update}"
        MR_DESCRIPTION="${CI_MERGE_REQUEST_DESCRIPTION:-Automated changes}"
        
        # Determinar tipo de mudan√ßa baseado no t√≠tulo
        CHANGE_TYPE="patch"
        if echo "$MR_TITLE" | grep -qiE "^feat|^feature|^add"; then
          CHANGE_TYPE="minor"
        elif echo "$MR_TITLE" | grep -qiE "^breaking|^major|BREAKING CHANGE"; then
          CHANGE_TYPE="major"
        fi
        
        # Criar changeset
        CHANGESET_ID=$(date +%s)
        cat > .changeset/auto-${CHANGESET_ID}.md <<EOF
    ---
    "@anpdgovbr/shared-ui": ${CHANGE_TYPE}
    ---

    ${MR_TITLE}

    ${MR_DESCRIPTION}
    EOF
        
        echo "‚úÖ Changeset criado automaticamente: .changeset/auto-${CHANGESET_ID}.md"
        echo "   Tipo: ${CHANGE_TYPE}"
        
        # Configurar git
        git config user.name "GitLab CI"
        git config user.email "ci@anpd.gov.br"
        
        # Commit e push do changeset
        git add .changeset/
        git commit -m "chore: add automatic changeset for MR !${CI_MERGE_REQUEST_IID}"
        git push origin HEAD:${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}
        
        echo "üì§ Changeset commitado e enviado"
      else
        echo "‚úÖ Changeset j√° existe, nenhuma a√ß√£o necess√°ria"
        ls -la .changeset/*.md | grep -v 'README.md' | grep -v 'config.json'
      fi

  allow_failure: true

# Job para verificar e aplicar changesets
version-bump:
  stage: deploy
  timeout: 10m
  needs:
    - build

  # Executar apenas na main ap√≥s merge (exceto se j√° for commit de version bump)
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/'
      when: on_success
    - when: never

  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
    
    # Reinstalar depend√™ncias
    - |
      if [ ! -d "node_modules" ]; then
        echo "‚ö†Ô∏è Instalando depend√™ncias..."
        pnpm install --frozen-lockfile
      fi

  script:
    - echo "üîç Verificando changesets pendentes..."
    
    # Verificar se h√° changesets para processar
    - |
      CHANGESETS=$(ls .changeset/*.md 2>/dev/null | grep -v 'README.md' | grep -v 'config.json' || true)
      if [ -z "$CHANGESETS" ]; then
        echo "‚ÑπÔ∏è Nenhum changeset pendente. Pulando bump de vers√£o."
        echo "‚ö†Ô∏è IMPORTANTE: Sem changeset n√£o haver√° publica√ß√£o!"
        exit 0
      fi
    
    - echo "üì¶ Changesets encontrados:"
    - ls -la .changeset/*.md | grep -v 'README.md' | grep -v 'config.json'
    - echo ""
    - echo "Aplicando bump de vers√£o..."
    
    # Configurar git
    - git config user.name "GitLab CI"
    - git config user.email "ci@anpd.gov.br"
    
    # Aplicar changesets
    - pnpm changeset version
    
    # Verificar se houve mudan√ßas (seguran√ßa extra)
    - |
      if git diff --quiet package.json CHANGELOG.md; then
        echo "‚ÑπÔ∏è Nenhuma mudan√ßa de vers√£o necess√°ria (changesets vazios?)"
        exit 0
      fi
    
    # Commit das mudan√ßas
    - git add package.json CHANGELOG.md .changeset/
    - git commit -m "chore: version bump via changesets [skip ci]"
    - git push origin main
    
    - echo "‚úÖ Vers√£o atualizada e commitada"
    
    # Criar tag
    - NEW_VERSION=$(node -p "require('./package.json').version")
    - git tag "v${NEW_VERSION}"
    - git push origin "v${NEW_VERSION}"
    - echo "üè∑Ô∏è Tag v${NEW_VERSION} criada e publicada"
    - echo "üöÄ Pr√≥ximo passo: Job 'publish' ser√° executado automaticamente"

  artifacts:
    paths:
      - package.json
      - CHANGELOG.md
    expire_in: 1 week

publish:
  stage: deploy
  timeout: 10m
  needs:
    - build

  # Publicar APENAS quando h√° tag de vers√£o (criada pelo version-bump)
  # Isso garante que S√ì publica se houver changeset
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/'
      when: on_success
    - when: never

  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate

    # Configura reposit√≥rio interno ANPD Verdaccio
    - echo "//npm.anpd.gov.br/:_authToken=${NPM_TOKEN}" > ~/.npmrc
    - pnpm config set registry https://npm.anpd.gov.br
    - npm config set registry https://npm.anpd.gov.br
    - echo "üîê Token configurado e registry apontado para npm.anpd.gov.br"

    # Reinstalar depend√™ncias (garantia)
    - pnpm config set store-dir .pnpm-store
    - |
      if [ ! -d "node_modules" ]; then
        echo "‚ö†Ô∏è node_modules n√£o encontrado. Instalando depend√™ncias..."
        pnpm install --frozen-lockfile
      fi

  script:
    - echo "üìã Verificando vers√£o atual..."
    - PACKAGE_VERSION=$(node -p "require('./package.json').version")
    - echo "   Vers√£o do package.json: ${PACKAGE_VERSION}"
    - echo "   Tag que disparou: ${CI_COMMIT_TAG}"
    
    # Validar que a vers√£o da tag corresponde ao package.json
    - |
      TAG_VERSION=${CI_COMMIT_TAG#v}
      if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
        echo "‚ùå ERRO: Vers√£o da tag ($TAG_VERSION) n√£o corresponde ao package.json ($PACKAGE_VERSION)"
        exit 1
      fi
      echo "‚úÖ Vers√£o validada: ${PACKAGE_VERSION}"
    
    # Verificar se a vers√£o j√° existe no registro
    - |
      echo "üîç Verificando se vers√£o ${PACKAGE_VERSION} j√° foi publicada..."
      
      # Tentar obter informa√ß√µes da vers√£o publicada
      PUBLISHED_VERSION=$(npm view @anpdgovbr/shared-ui@${PACKAGE_VERSION} version 2>/dev/null || echo "not-found")
      
      if [ "$PUBLISHED_VERSION" = "$PACKAGE_VERSION" ]; then
        echo "‚ö†Ô∏è Vers√£o ${PACKAGE_VERSION} j√° est√° publicada no Verdaccio"
        echo "‚ÑπÔ∏è Pulando publica√ß√£o para evitar erro"
        exit 0
      fi
      
      echo "‚úÖ Vers√£o ${PACKAGE_VERSION} ainda n√£o publicada, prosseguindo..."
    
    - echo "üöÄ Publicando pacote para o Verdaccio interno..."
    - pnpm publish --access public --no-git-checks
    - echo "üéâ Publica√ß√£o da vers√£o ${PACKAGE_VERSION} conclu√≠da com sucesso!"
    - echo "üì¶ Pacote dispon√≠vel: @anpdgovbr/shared-ui@${PACKAGE_VERSION}"

  artifacts:
    when: on_failure
    expire_in: 1 week

# ==========================================
# STAGE: BUILD STORYBOOK (DESABILITADO)
# ==========================================
# Job para build do Storybook (apenas na main)
# NOTA: Comentado para ativa√ß√£o posterior
# build-storybook:
#   stage: build
#   timeout: 20m
#   needs: [install]
#
#   # Executar apenas na branch main
#   only:
#     - main
#
#   before_script:
#     - corepack enable
#     - corepack prepare pnpm@${PNPM_VERSION} --activate
#
#   script:
#     - echo "üìö Executando build do Storybook..."
#     - pnpm run build-storybook
#     - echo "‚úÖ Storybook build conclu√≠do com sucesso"
#
#   artifacts:
#     paths:
#       - storybook-static/
#     expire_in: 7 days

# ==========================================
# STAGE: DEPLOY (DESABILITADO)
# ==========================================
# Job para deploy do Storybook (manual)
# NOTA: Comentado para ativa√ß√£o posterior
# deploy-storybook:
#   stage: deploy
#   timeout: 10m
#   needs: [build-storybook]
#
#   # Deploy manual apenas na main
#   only:
#     - main
#   when: manual
#
#   before_script:
#     - corepack enable
#     - corepack prepare pnpm@${PNPM_VERSION} --activate
#
#   script:
#     - echo "üöÄ Iniciando deploy do Storybook..."
#     # Customize este script conforme seu ambiente de deploy
#     - |
#       if [ -f "./deploy-storybook.sh" ]; then
#         chmod +x ./deploy-storybook.sh
#         NGINX_RELOAD=true ./deploy-storybook.sh
#       else
#         echo "‚ö†Ô∏è Script de deploy n√£o encontrado"
#         echo "üì¶ Artefatos dispon√≠veis em storybook-static/"
#       fi
#     - echo "‚úÖ Deploy conclu√≠do"
#
#   environment:
#     name: storybook
#     url: https://seu-dominio.gov.br/shared-ui
#
#   artifacts:
#     paths:
#       - storybook-static/
#     expire_in: 30 days

# ==========================================
# JOBS AUXILIARES
# ==========================================

# Job para verificar seguran√ßa de depend√™ncias
security-check:
  stage: test
  timeout: 10m
  needs: []

  # Usar cache ao inv√©s de artifacts
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules/
    policy: pull

  # Executar apenas em MRs e main
  only:
    - merge_requests
    - main

  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
    # Reinstalar se cache n√£o estiver dispon√≠vel
    - |
      if [ ! -d "node_modules" ]; then
        echo "‚ö†Ô∏è Cache n√£o encontrado, instalando depend√™ncias..."
        pnpm install --frozen-lockfile
      fi

  script:
    - echo "üîí Verificando vulnerabilidades de seguran√ßa..."
    - pnpm audit --audit-level=moderate || echo "‚ö†Ô∏è Vulnerabilidades encontradas"

  allow_failure: true

# Job para an√°lise de bundle size (informativo)
# NOTA: Comentado para ativa√ß√£o posterior
# bundle-analysis:
#   stage: build
#   timeout: 15m
#   needs: [build]
#
#   # Executar apenas na main
#   only:
#     - main
#
#   before_script:
#     - corepack enable
#     - corepack prepare pnpm@${PNPM_VERSION} --activate
#
#   script:
#     - echo "üìä Analisando tamanho do bundle..."
#     - ls -lh dist/
#     - du -sh dist/
#
#   allow_failure: true

# ==========================================
# WORKFLOW RULES
# ==========================================
workflow:
  rules:
    # Executar em pushes para main
    - if: $CI_COMMIT_BRANCH == "main"
    # Executar em merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Executar em tags
    - if: $CI_COMMIT_TAG
